name: Build and Test

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5.1.0
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # v5.0.0

      - name: Build and test runtime module
        run: ./gradlew :license-scribe-runtime:build -PexcludeExample --no-configuration-cache

      - name: Build and test core module
        run: ./gradlew :license-scribe-core:build -PexcludeExample --no-configuration-cache

      - name: Build and test plugin modules
        run: ./gradlew :license-scribe-gradle-plugin:build :license-scribe-hilt-plugin:build :license-scribe-screen-plugin:build -PexcludeExample --no-configuration-cache

      - name: Publish all modules to Maven Local
        run: ./gradlew :license-scribe-runtime:publishToMavenLocal :license-scribe-core:publishToMavenLocal :license-scribe-gradle-plugin:publishToMavenLocal :license-scribe-hilt-plugin:publishToMavenLocal :license-scribe-screen-plugin:publishToMavenLocal -PexcludeExample --no-configuration-cache

      - name: "Test: checkLicenses passes with valid definitions"
        run: ./scripts/test-check-valid.sh

      - name: "Test: checkLicenses fails when definition is missing"
        run: ./scripts/test-check-missing.sh

      - name: "Test: syncLicenses adds new dependency"
        run: ./scripts/test-sync-add.sh

      - name: "Test: syncLicenses removes deleted dependency"
        run: ./scripts/test-sync-remove.sh

      - name: "Test: initLicenses creates files"
        run: ./scripts/test-init.sh

      - name: "Test: generateLicenseCode creates valid Kotlin"
        run: ./scripts/test-generate.sh

      - name: "Test: generateHiltModule creates valid Hilt module"
        run: ./scripts/test-generate-hilt.sh

      - name: "Test: Configuration Cache compatibility"
        run: ./scripts/test-configuration-cache.sh
