name: Build and Test

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@0723195856401067f7a2779048b490ace7a47d7c # v5.0.2

      - name: Build and test runtime module
        run: ./gradlew :license-scribe-runtime:build -PexcludeExample --no-configuration-cache

      - name: Build and test core module
        run: ./gradlew :license-scribe-core:build -PexcludeExample --no-configuration-cache

      - name: Build and test plugin modules
        run: ./gradlew :license-scribe-gradle-plugin:build :license-scribe-hilt-plugin:build :license-scribe-screen-plugin:build -PexcludeExample --no-configuration-cache

      - name: Publish all modules to Maven Local
        run: ./gradlew :license-scribe-runtime:publishToMavenLocal :license-scribe-core:publishToMavenLocal :license-scribe-gradle-plugin:publishToMavenLocal :license-scribe-hilt-plugin:publishToMavenLocal :license-scribe-screen-plugin:publishToMavenLocal -PexcludeExample --no-configuration-cache

      - name: "Test: checkLicenses passes with valid definitions"
        run: ./scripts/test-check-valid.sh

      - name: "Test: checkLicenses fails when definition is missing"
        run: ./scripts/test-check-missing.sh

      - name: "Test: syncLicenses adds new dependency"
        run: ./scripts/test-sync-add.sh

      - name: "Test: syncLicenses removes deleted dependency"
        run: ./scripts/test-sync-remove.sh

      - name: "Test: initLicenses creates files"
        run: ./scripts/test-init.sh

      - name: "Test: generateLicenseCode creates valid Kotlin"
        run: ./scripts/test-generate.sh

      - name: "Test: generateHiltModule creates valid Hilt module"
        run: ./scripts/test-generate-hilt.sh

      - name: "Test: Configuration Cache compatibility"
        run: ./scripts/test-configuration-cache.sh
